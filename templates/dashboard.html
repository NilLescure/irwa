{% extends "base.html" %}
{% block page_title %}{{ page_title }}{% endblock %}

{% block header %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body {
      background: #ffffff;
  }

  .dashboard-container {
      max-width: 1200px;
      margin: 20px auto 40px auto;
      padding: 0 15px;
  }

  .nav-bar {
      margin-bottom: 15px;
      font-size: 0.95rem;
  }

  .nav-bar a {
      color: #2563eb;
      text-decoration: none;
      margin-right: 8px;
  }

  .nav-bar a:hover {
      text-decoration: underline;
  }

  h1 {
      margin-top: 10px;
      margin-bottom: 10px;
      font-size: 1.8rem;
      color: #111827;
  }

  h2 {
      margin-top: 30px;
      font-size: 1.3rem;
      color: #111827;
  }

  .chart-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 20px;
      margin-top: 20px;
  }

  .chart-card {
      background: #ffffff;
      border-radius: 12px;
      padding: 16px 18px;
      box-shadow: 0 2px 8px rgba(15, 23, 42, 0.08);
  }

  .chart-card h3 {
      margin: 0 0 10px 0;
      font-size: 1.05rem;
      color: #111827;
  }

  .chart-wrapper {
      position: relative;
      height: 260px;
  }

  .info-cards {
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
      margin: 20px 0;
  }

  .info-card {
      flex: 1 1 220px;
      background: linear-gradient(135deg, #eff6ff, #e0f2fe);
      padding: 14px 16px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(15, 23, 42, 0.08);
      min-width: 220px;
  }

  .info-card h4 {
      margin: 0 0 6px 0;
      font-size: 0.95rem;
      color: #1f2937;
  }

  .info-card p {
      margin: 0;
      font-size: 0.85rem;
      color: #4b5563;
  }

  .summary-row {
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
      margin-top: 10px;
  }

  .summary-pill {
      background: #eef2ff;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 0.85rem;
      color: #4b5563;
  }

  .location-block {
      margin-top: 10px;
      font-size: 0.9rem;
      color: #374151;
  }

  .location-block strong {
      color: #111827;
  }

</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">

    <!-- Navigation -->
    <div class="nav-bar">
        <a href="/">Home</a> |
        <a href="/stats">Stats</a>
        {% if session.last_search_query %}
            | <a href="{{ url_for('last_search') }}">Previous results</a>
        {% endif %}
    </div>

    <h1>{{ page_title }}</h1>

    <!-- Summary pills -->
    <div class="summary-row">
        <div class="summary-pill">
            <strong>Total Sessions:</strong> {{ http_stats.sessions|length }}
        </div>
        <div class="summary-pill">
            <strong>Total HTTP Requests:</strong> {{ http_stats.requests|length }}
        </div>
        <div class="summary-pill">
            <strong>Queries (unique):</strong> {{ query_stats.queries|length }}
        </div>
        <div class="summary-pill">
            <strong>Docs with clicks:</strong> {{ ranked_docs|length }}
        </div>
        <div class="summary-pill">
            <strong>Missions (current session):</strong> {{ current_session.missions|length }}
        </div>
    </div>

    <!-- User Information Summary -->
    <h2>User Information Summary</h2>
    <div class="info-cards">
        {% set browser_counts = {} %}
        {% for ua in http_stats.user_agents %}
            {% set browser = ua %}
            {% if browser_counts[browser] is defined %}
                {% set _ = browser_counts.update({browser: browser_counts[browser]+1}) %}
            {% else %}
                {% set _ = browser_counts.update({browser: 1}) %}
            {% endif %}
        {% endfor %}

        {% for browser, count in browser_counts.items() %}
            <div class="info-card">
                <h4>{{ browser }}</h4>
                <p>Requests: {{ count }}</p>
            </div>
        {% endfor %}

        {% if browser_counts|length == 0 %}
            <div class="info-card">
                <h4>No HTTP requests</h4>
                <p>There are no logged requests yet.</p>
            </div>
        {% endif %}
    </div>

    <div class="location-block">
        <p><strong>Location (current session):</strong> {{ current_session.city }}, {{ current_session.country }}</p>
        <p><strong>Missions in this session:</strong> {{ current_session.missions|length }}</p>
    </div>

    <!-- Charts -->
    <h2>Analytics Charts</h2>
    <div class="chart-grid">

        <!-- Top Clicked Documents -->
        <div class="chart-card">
            <h3>Top Clicked Documents (by title)</h3>
            <div class="chart-wrapper">
                <canvas id="docClicksChart"></canvas>
            </div>
        </div>

        <!-- Average Dwell Time per Document -->
        <div class="chart-card">
            <h3>Average Dwell Time (seconds)</h3>
            <div class="chart-wrapper">
                <canvas id="dwellTimeChart"></canvas>
            </div>
        </div>

        <!-- Query Frequency -->
        <div class="chart-card">
            <h3>Query Frequency</h3>
            <div class="chart-wrapper">
                <canvas id="queryFreqChart"></canvas>
            </div>
        </div>

        <!-- HTTP Requests by Method -->
        <div class="chart-card">
            <h3>HTTP Requests by Method</h3>
            <div class="chart-wrapper">
                <canvas id="httpMethodChart"></canvas>
            </div>
        </div>

        <!-- Active Sessions -->
        <div class="chart-card">
            <h3>Sessions Overview (# Requests per Session)</h3>
            <div class="chart-wrapper">
                <canvas id="sessionChart"></canvas>
            </div>
        </div>

    </div>
</div>

<script>
/* ---------------------- Data Preparation ---------------------- */

// Documents clicks (ara fem servir el TITLE)
const docLabels = {{ ranked_docs | map(attribute='title') | list | safe }};
const docClicks = {{ ranked_docs | map(attribute='clicks') | list | safe }};

// Average dwell time
const dwellTimes = {{ ranked_docs | map(attribute='avg_dwell_time') | list | safe }};

// Queries (freqüència per text)
const queryLabels = {{ query_stats.queries | map(attribute='query') | list | safe }};
const queryCounts = {{ query_stats.queries | map(attribute='count') | list | safe }};

// HTTP requests by method
const httpMethods = {{ http_stats.requests | map(attribute='method') | list | safe }};
const httpMethodCounts = {};
httpMethods.forEach(function(m) { httpMethodCounts[m] = (httpMethodCounts[m] || 0) + 1; });
const httpLabels = Object.keys(httpMethodCounts);
const httpCounts = Object.values(httpMethodCounts);

// Sessions
const sessionLabels = {{ http_stats.sessions.keys() | list | safe }};
const sessionReqs = {{ http_stats.sessions.values() | map(attribute='num_requests') | list | safe }};


/* ---------------------- Charts ---------------------- */

function baseBarOptions(title) {
    return {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: false },
            tooltip: {
                backgroundColor: 'rgba(15,23,42,0.9)',
                titleColor: '#e5e7eb',
                bodyColor: '#e5e7eb',
            },
        },
        scales: {
            x: {
                ticks: {
                    maxRotation: 45,
                    minRotation: 0,
                    autoSkip: true,
                },
                grid: {
                    display: false
                }
            },
            y: {
                beginAtZero: true,
                grid: {
                    color: 'rgba(209, 213, 219, 0.5)'
                }
            }
        }
    };
}

// Top Clicked Documents
new Chart(document.getElementById('docClicksChart').getContext('2d'), {
    type: 'bar',
    data: {
        labels: docLabels,
        datasets: [{
            label: 'Clicks',
            data: docClicks,
            backgroundColor: 'rgba(59, 130, 246, 0.75)'
        }]
    },
    options: baseBarOptions('Top Clicked Documents')
});

// Average Dwell Time
new Chart(document.getElementById('dwellTimeChart').getContext('2d'), {
    type: 'bar',
    data: {
        labels: docLabels,
        datasets: [{
            label: 'Avg Dwell Time (s)',
            data: dwellTimes,
            backgroundColor: 'rgba(239, 68, 68, 0.75)'
        }]
    },
    options: baseBarOptions('Average Dwell Time')
});

// Query Frequency
new Chart(document.getElementById('queryFreqChart').getContext('2d'), {
    type: 'bar',
    data: {
        labels: queryLabels,
        datasets: [{
            label: '#Times queried',
            data: queryCounts,
            backgroundColor: 'rgba(16, 185, 129, 0.75)'
        }]
    },
    options: baseBarOptions('Query Frequency')
});

// HTTP Requests by Method
new Chart(document.getElementById('httpMethodChart').getContext('2d'), {
    type: 'pie',
    data: {
        labels: httpLabels,
        datasets: [{
            label: 'HTTP Methods',
            data: httpCounts,
            backgroundColor: [
                'rgba(59, 130, 246, 0.8)',
                'rgba(16, 185, 129, 0.8)',
                'rgba(234, 179, 8, 0.8)',
                'rgba(239, 68, 68, 0.8)'
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { position: 'bottom' }
        }
    }
});

// Sessions Overview
new Chart(document.getElementById('sessionChart').getContext('2d'), {
    type: 'bar',
    data: {
        labels: sessionLabels,
        datasets: [{
            label: '# Requests',
            data: sessionReqs,
            backgroundColor: 'rgba(147, 51, 234, 0.75)'
        }]
    },
    options: baseBarOptions('Sessions Overview')
});
</script>
{% endblock %}
