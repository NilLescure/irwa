{% extends "base.html" %}
{% block page_title %}{{ page_title }}{% endblock %}

{% block header %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  .chart-container {
      width: 80%;
      margin: 30px auto;
  }
</style>
{% endblock %}

{% block content %}
    <!-- Navigation -->
    <div class="mb-3">
        <a href="/">Home</a> |
        <a href="/stats">Stats</a>
        {% if session.last_search_query %}
            | <a href="{{ url_for('last_search') }}">Previous search</a>
        {% endif %}
    </div>
<h1>{{ page_title }}</h1>

<!-- 1️⃣ Top Clicked Documents -->
<div class="chart-container">
    <h3>Top Clicked Documents</h3>
    <canvas id="docClicksChart"></canvas>
</div>

<!-- 2️⃣ Average Dwell Time per Document -->
<div class="chart-container">
    <h3>Average Dwell Time (seconds)</h3>
    <canvas id="dwellTimeChart"></canvas>
</div>

<!-- 3️⃣ Query Frequency -->
<div class="chart-container">
    <h3>Query Frequency</h3>
    <canvas id="queryFreqChart"></canvas>
</div>

<!-- 4️⃣ HTTP Requests by Method -->
<div class="chart-container">
    <h3>HTTP Requests by Method</h3>
    <canvas id="httpMethodChart"></canvas>
</div>

<!-- 5️⃣ Active Sessions -->
<div class="chart-container">
    <h3>Sessions Overview (# Requests per Session)</h3>
    <canvas id="sessionChart"></canvas>
</div>
<!-- User Information Summary -->
<h2>User Information Summary</h2>
<div class="info-cards" style="display: flex; flex-wrap: wrap; gap: 20px; margin: 30px 0;">
    {% set browser_counts = {} %}
    {% for ua in http_stats.user_agents %}
        {% set browser = ua %}
        {% if browser_counts[browser] is defined %}
            {% set _ = browser_counts.update({browser: browser_counts[browser]+1}) %}
        {% else %}
            {% set _ = browser_counts.update({browser: 1}) %}
        {% endif %}
    {% endfor %}

    {% for browser, count in browser_counts.items() %}
        <div class="card" style="flex: 1 1 200px; background: #f0f4f8; padding: 15px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);">
            <h4 style="margin:0 0 5px 0;">{{ browser }}</h4>
            <p style="margin:0; font-size: 14px;">Requests: {{ count }}</p>
        </div>
    {% endfor %}

    {% if browser_counts|length == 0 %}
        <div style="padding: 20px; background: #f0f4f8; border-radius: 10px;">No HTTP requests logged yet.</div>
    {% endif %}
</div>
<p><strong>Location:</strong> {{ session.city }}, {{ session.country }}</p>
<p><strong>Missions:</strong> {{ session.missions|length }}</p>

<!-- Optional: more details -->
<div style="margin-top: 20px;">
    <p><strong>Total Sessions:</strong> {{ http_stats.sessions|length }}</p>
    <p><strong>Total HTTP Requests:</strong> {{ http_stats.requests|length }}</p>
</div>


<script>
/* ---------------------- Data Preparation ---------------------- */

// 1️⃣ Documents clicks
const docLabels = {{ ranked_docs | map(attribute='doc_id') | list | safe }};
const docClicks = {{ ranked_docs | map(attribute='clicks') | list | safe }};

// 2️⃣ Average dwell time
const dwellTimes = {{ ranked_docs | map(attribute='avg_dwell_time') | list | safe }};

// 3️⃣ Queries
const queryLabels = {{ query_stats.queries | map(attribute='query') | list | safe }};
const queryCounts = {{ query_stats.queries | map(attribute='num_terms') | list | safe }}; // example metric

// 4️⃣ HTTP requests by method
const httpMethods = {{ http_stats.requests | map(attribute='method') | list | safe }};
const httpMethodCounts = {};
httpMethods.forEach(function(m) { httpMethodCounts[m] = (httpMethodCounts[m] || 0) + 1; });
const httpLabels = Object.keys(httpMethodCounts);
const httpCounts = Object.values(httpMethodCounts);

// 5️⃣ Sessions
const sessionLabels = {{ http_stats.sessions.keys() | list | safe }};
const sessionReqs = {{ http_stats.sessions.values() | map(attribute='num_requests') | list | safe }};
const userAgents = {{ http_stats.user_agents | safe }};

// Count browsers
const browserCounts = {};
userAgents.forEach(ua => {
    browserCounts[ua] = (browserCounts[ua] || 0) + 1;
});
const browserLabels = Object.keys(browserCounts);
const browserData = Object.values(browserCounts);


/* ---------------------- Charts ---------------------- */

// 1️⃣ Top Clicked Documents
new Chart(document.getElementById('docClicksChart').getContext('2d'), {
    type: 'bar',
    data: {
        labels: docLabels,
        datasets: [{
            label: 'Clicks',
            data: docClicks,
            backgroundColor: 'rgba(54, 162, 235, 0.7)'
        }]
    },
    options: {
        responsive: true,
        plugins: { legend: { display: false } }
    }
});

// 2️⃣ Average Dwell Time
new Chart(document.getElementById('dwellTimeChart').getContext('2d'), {
    type: 'bar',
    data: {
        labels: docLabels,
        datasets: [{
            label: 'Avg Dwell Time (s)',
            data: dwellTimes,
            backgroundColor: 'rgba(255, 159, 64, 0.7)'
        }]
    },
    options: { responsive: true, plugins: { legend: { display: false } } }
});

// 3️⃣ Query Frequency
new Chart(document.getElementById('queryFreqChart').getContext('2d'), {
    type: 'bar',
    data: {
        labels: queryLabels,
        datasets: [{
            label: '#Terms in Query',
            data: queryCounts,
            backgroundColor: 'rgba(75, 192, 192, 0.7)'
        }]
    },
    options: { responsive: true }
});

// 4️⃣ HTTP Requests by Method
new Chart(document.getElementById('httpMethodChart').getContext('2d'), {
    type: 'pie',
    data: {
        labels: httpLabels,
        datasets: [{
            label: 'HTTP Methods',
            data: httpCounts,
            backgroundColor: [
                'rgba(255, 99, 132, 0.7)',
                'rgba(54, 162, 235, 0.7)',
                'rgba(255, 206, 86, 0.7)',
                'rgba(75, 192, 192, 0.7)'
            ]
        }]
    },
    options: { responsive: true }
});

// 5️⃣ Sessions Overview
new Chart(document.getElementById('sessionChart').getContext('2d'), {
    type: 'bar',
    data: {
        labels: sessionLabels,
        datasets: [{
            label: '# Requests',
            data: sessionReqs,
            backgroundColor: 'rgba(153, 102, 255, 0.7)'
        }]
    },
    options: { responsive: true }
});



</script>
{% endblock %}
